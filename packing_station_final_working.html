<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Station - Smart Dispatch</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        [data-theme="dark"] body {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        [data-theme="dark"] .bg-white { background-color: #1f2a3a; }
        [data-theme="dark"] .text-slate-800 { color: #f1f5f9; }
        [data-theme="dark"] .text-slate-900 { color: #ffffff; }
        [data-theme="dark"] .text-slate-600 { color: #94a3b8; }
        [data-theme="dark"] .text-slate-500 { color: #64748b; }
        [data-theme="dark"] .border-slate-200 { border-color: #475569; }
        [data-theme="dark"] .bg-slate-50 { background-color: #334155; }
        [data-theme="dark"] .hover\:bg-slate-100:hover { background-color: #475569; }
        [data-theme="dark"] .bg-indigo-100 { background-color: #3730a3; }
        [data-theme="dark"] .text-indigo-700 { color: #a5b4fc; }
        [data-theme="dark"] .active { background-color: #3730a3; border-left-color: #a5b4fc; }
        [data-theme="dark"] .scanner-input { background-color: #475569; border-color: #64748b; }
        [data-theme="dark"] .packed-item { background-color: #064e3b; }

        .sidebar { transition: all 0.3s ease; width: 256px; }
        .sidebar.collapsed { width: 80px; }
        .sidebar-item-text, .sidebar-brand-text { transition: all 0.2s ease; }
        .sidebar.collapsed .sidebar-item-text, .sidebar.collapsed .sidebar-brand-text { opacity: 0; pointer-events: none; width: 0; }
        
        .scanner-input:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
            border-color: #6366f1;
        }
        .queue-item { transition: all 0.2s ease-in-out; border-left-width: 4px; }
        .queue-item.active {
            background-color: #e0e7ff;
            border-left-color: #4f46e5;
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .packed-item {
            background-color: #f0fdf4;
            color: #6b7280;
            text-decoration: line-through;
        }
        .modal { display: none; }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .toast { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.hide { transform: translateY(100%); opacity: 0; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-white shadow-xl p-4 flex flex-col justify-between">
            <div>
                <div class="flex items-center justify-between mb-8 p-2">
                    <a href="./index.html" class="flex items-center space-x-3 overflow-hidden">
                        <div class="bg-indigo-600 p-2 rounded-lg shadow flex-shrink-0">
                            <i class="ph-bold ph-list-dashes text-white text-lg"></i>
                        </div>
                        <span class="sidebar-brand-text text-xl font-extrabold tracking-tight text-slate-900 whitespace-nowrap">Smart Dispatch</span>
                    </a>
                    <button id="sidebar-toggle" class="p-1 rounded-md hover:bg-slate-100">
                        <i class="ph-bold ph-caret-left text-slate-500"></i>
                    </button>
                </div>
                <nav>
                    <ul class="space-y-2">
                        <li><a href="./index.html" class="flex items-center space-x-4 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold"><i class="ph-fill ph-house-simple text-xl"></i><span class="sidebar-item-text">Dashboard</span></a></li>
                        <li><a href="./daily_dispatch.html" class="flex items-center space-x-4 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold"><i class="ph-fill ph-cloud-arrow-up text-xl"></i><span class="sidebar-item-text">Daily Dispatch</span></a></li>
                        <li><a href="./packing_station_final_working.html" class="flex items-center space-x-4 p-3 rounded-lg text-indigo-700 bg-indigo-100 font-semibold"><i class="ph-fill ph-package text-xl"></i><span class="sidebar-item-text">Packing Station</span></a></li>
                        <li><a href="./shipment_management_final.html" class="flex items-center space-x-4 p-3 rounded-lg text-slate-600 hover:bg-slate-100 font-semibold"><i class="ph-fill ph-truck text-xl"></i><span class="sidebar-item-text">Shipments</span></a></li>
                    </ul>
                </nav>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50">
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <div class="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center flex-shrink-0"><span class="font-bold text-indigo-800" id="user-initials"></span></div>
                        <div class="sidebar-item-text flex flex-col"><span class="text-sm font-semibold text-slate-800 whitespace-nowrap" id="user-display">Loading...</span><span class="text-xs text-slate-500 whitespace-nowrap" id="user-role-display"></span></div>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-md hover:bg-slate-200"><i class="ph-bold ph-sign-out text-slate-500 text-lg"></i></button>
                </div>
                <div class="flex items-center space-x-3 p-2 rounded-lg bg-slate-50 justify-between">
                    <span class="text-xs font-semibold text-slate-600 sidebar-item-text">Dark Mode</span>
                    <button id="theme-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 transition-colors"><span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform" id="theme-circle"></span></button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-6 lg:p-8 overflow-auto">
            <h1 class="text-3xl font-extrabold text-slate-900 mb-8">Packing Station</h1>
            
            <!-- Scanner Input -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8 sticky top-0 z-10">
                <label for="scanner-input" class="block text-sm font-bold text-slate-700 mb-2">Scan Box ID to Activate</label>
                <div class="relative">
                    <i class="ph-bold ph-barcode text-lg absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="scanner-input" placeholder="Waiting for scan..." class="scanner-input w-full pl-12 pr-4 py-3 text-lg font-semibold text-slate-800 bg-slate-50 rounded-lg border-2 border-slate-300 transition-all">
                </div>
            </div>

            <!-- Packing Area -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left: Packing Queue -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Packing Queue</h2>
                    <div id="packing-queue" class="space-y-3 max-h-[65vh] overflow-y-auto pr-2">
                        <div id="queue-placeholder" class="text-center py-16 bg-white rounded-2xl shadow-md border border-slate-200">
                            <div class="h-12 w-12 border-4 border-indigo-500 border-t-transparent rounded-full spinner mx-auto"></div>
                            <p class="mt-4 font-semibold text-slate-600">Loading pending boxes...</p>
                        </div>
                    </div>
                </div>

                <!-- Middle: Active Box Area -->
                <div class="lg:col-span-6">
                    <div id="active-box-placeholder" class="flex flex-col items-center justify-center h-full bg-white rounded-2xl shadow-lg border border-slate-200 text-center p-8">
                        <i class="ph-bold ph-package text-6xl text-indigo-300"></i>
                        <h3 class="mt-4 text-xl font-bold text-slate-700">No Active Box</h3>
                        <p class="text-slate-500 mt-1">Scan a Box ID from the queue to begin packing.</p>
                    </div>
                    <div id="active-box-details" class="hidden">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-6">
                            <h2 class="text-2xl font-bold text-indigo-700 font-mono" id="box-id-display"></h2>
                            <p class="text-slate-600 mt-1" id="store-info-display"></p>
                            <div class="mt-4">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-medium text-slate-700">Packing Progress</span>
                                    <span class="text-sm font-bold text-slate-800" id="progress-text">0 / 0</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-4">
                                    <div id="progress-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 flex flex-col">
                                <h3 class="text-lg font-semibold mb-4 text-center text-slate-800">Pending Items</h3>
                                <ul id="pending-items" class="space-y-2 overflow-y-auto flex-grow min-h-[200px]"></ul>
                            </div>
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 flex flex-col">
                                <h3 class="text-lg font-semibold mb-4 text-center text-slate-800">Packed Items</h3>
                                <ul id="packed-items" class="space-y-2 overflow-y-auto flex-grow min-h-[200px]"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Activity Log -->
                <div class="lg:col-span-3">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Activity Log</h2>
                    <div id="activity-log" class="bg-white p-4 rounded-2xl shadow-lg border border-slate-200 space-y-3 min-h-[65vh] max-h-[65vh] overflow-y-auto flex flex-col-reverse">
                        <p id="activity-placeholder" class="text-sm text-slate-400 text-center pt-12">No activity yet.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals & Toasts -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <!-- Exception Modal -->
    <div id="exception-modal" class="modal fixed inset-0 bg-black/60 z-30 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
            <div class="flex items-start space-x-4">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-amber-100 sm:mx-0 sm:h-10 sm:w-10">
                    <i class="ph-bold ph-warning text-2xl text-amber-600"></i>
                </div>
                <div class="flex-grow">
                    <h3 class="text-xl leading-6 font-bold text-slate-900">Packing Exception</h3>
                    <p class="mt-2 text-slate-500" id="exception-message"></p>
                    <div class="mt-4 bg-slate-50 p-3 rounded-lg">
                        <label for="exception-reason" class="block text-xs font-medium text-slate-600">Reason for moving (optional)</label>
                        <input type="text" id="exception-reason" placeholder="e.g., Customer request" class="mt-1 w-full text-sm border-slate-300 rounded-md shadow-sm">
                    </div>
                </div>
            </div>
            <div class="mt-6 sm:mt-4 sm:flex sm:flex-row-reverse gap-3">
                <button id="exception-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:w-auto sm:text-sm">Move to Active Box</button>
                <button id="exception-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        // UPGRADE: Import credentials from the central config file
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let dispatchQueue = [];
            let activeBox = null;
            let currentUser = null;
            let isLoading = false;
            let exceptionContext = null;

            // --- UI ELEMENTS ---
            const UI = {
                sidebar: document.getElementById('sidebar'),
                sidebarToggle: document.getElementById('sidebar-toggle'),
                themeToggle: document.getElementById('theme-toggle'),
                themeCircle: document.getElementById('theme-circle'),
                userDisplay: document.getElementById('user-display'),
                userInitials: document.getElementById('user-initials'),
                userRoleDisplay: document.getElementById('user-role-display'),
                logoutBtn: document.getElementById('logout-btn'),
                toastContainer: document.getElementById('toast-container'),
                scannerInput: document.getElementById('scanner-input'),
                scannerLabel: document.querySelector('label[for="scanner-input"]'),
                packingQueue: document.getElementById('packing-queue'),
                queuePlaceholder: document.getElementById('queue-placeholder'),
                activeBoxPlaceholder: document.getElementById('active-box-placeholder'),
                activeBoxDetails: document.getElementById('active-box-details'),
                boxIdDisplay: document.getElementById('box-id-display'),
                storeInfoDisplay: document.getElementById('store-info-display'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar'),
                pendingItems: document.getElementById('pending-items'),
                packedItems: document.getElementById('packed-items'),
                activityLog: document.getElementById('activity-log'),
                activityPlaceholder: document.getElementById('activity-placeholder'),
                exceptionModal: document.getElementById('exception-modal'),
                exceptionMessage: document.getElementById('exception-message'),
                exceptionReason: document.getElementById('exception-reason'),
                exceptionCancelBtn: document.getElementById('exception-cancel-btn'),
                exceptionConfirmBtn: document.getElementById('exception-confirm-btn'),
            };

            // --- UTILITY FUNCTIONS ---
            const redirectTo = (page) => {
                const currentPath = window.location.pathname;
                const newPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1) + page;
                window.location.href = new URL(newPath, window.location.origin).href;
            };
            
            const showToast = (message, type = 'info') => {
                const toast = document.createElement('div');
                let bgColor = 'bg-slate-800';
                let icon = `<i class="ph-bold ph-info text-white"></i>`;
                if (type === 'success') { bgColor = 'bg-emerald-600'; icon = `<i class="ph-bold ph-check-circle text-white"></i>`; } 
                else if (type === 'error') { bgColor = 'bg-rose-600'; icon = `<i class="ph-bold ph-x-circle text-white"></i>`; }
                toast.className = `toast px-4 py-3 rounded-lg text-white shadow-lg flex items-center space-x-3 transform translate-y-full opacity-0 ${bgColor}`;
                toast.innerHTML = `${icon} <span class="font-semibold text-sm">${message}</span>`;
                UI.toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hide');
                    setTimeout(() => toast.remove(), 500);
                }, 5000);
            };
            
            const setTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if (theme === 'dark') {
                    UI.themeCircle.style.transform = 'translateX(20px)';
                } else {
                    UI.themeCircle.style.transform = 'translateX(0)';
                }
            };

            const addLogEntry = (message, type = 'info') => {
                UI.activityPlaceholder.classList.add('hidden');
                const div = document.createElement('div');
                const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                let icon;
                switch(type) {
                    case 'success': icon = `<i class="ph-bold ph-check-circle text-emerald-500"></i>`; break;
                    case 'error': icon = `<i class="ph-bold ph-x-circle text-rose-500"></i>`; break;
                    case 'warning': icon = `<i class="ph-bold ph-warning text-amber-500"></i>`; break;
                    default: icon = `<i class="ph-bold ph-info text-slate-400"></i>`;
                }
                div.className = 'flex items-start space-x-3 text-sm';
                div.innerHTML = `<div class="flex-shrink-0 pt-0.5">${icon}</div><div class="flex-grow"><p class="text-slate-700">${message}</p><p class="text-xs text-slate-400">${time}</p></div>`;
                UI.activityLog.prepend(div);
            };

            // --- CORE LOGIC ---
            const fetchDispatchQueue = async () => {
                const { data, error } = await db.from('boxes')
                    .select(`box_id, status, delivery_groups ( stores ( store_name, city ) )`)
                    .in('status', ['Pending', 'Packing']);

                if (error) {
                    showToast(`Error fetching queue: ${error.message}`, 'error');
                    console.error("Supabase error:", error);
                    return;
                }
                
                const processedData = data.map(box => {
                    const store = box.delivery_groups?.stores?.[0];
                    return {
                        box_id: box.box_id,
                        status: box.status,
                        store_name: store?.store_name || 'Unknown Store',
                        city: store?.city || 'N/A',
                    };
                }).sort((a, b) => a.box_id.localeCompare(b.box_id));

                dispatchQueue = processedData;
                renderQueue();
            };

            const activateBox = async (boxId) => {
                if (isLoading) { showToast('Please wait, another operation is in progress.', 'error'); return; }
                isLoading = true;
                UI.scannerInput.disabled = true;
                UI.scannerInput.placeholder = `Loading ${boxId}...`;

                try {
                    const { data, error } = await db.from('boxes')
                        .select('*, orders(*), delivery_groups(*, stores(*))')
                        .eq('box_id', boxId)
                        .limit(1)
                        .single();
                    
                    if (error || !data) { showToast(`Error: Box ID "${boxId}" not found.`, 'error'); return; }
                    if (data.status === 'Packed') { 
                        showToast(`Box "${boxId}" is already packed.`, 'info'); 
                        fetchDispatchQueue(); // Refresh queue to remove it
                        return; 
                    }
                    
                    const store = data.delivery_groups?.stores?.[0];
                    activeBox = { 
                        ...data, 
                        store_name: store?.store_name || 'Unknown Store',
                        city: store?.city || 'N/A',
                    };

                    addLogEntry(`Box <strong class="font-mono">${boxId}</strong> activated by ${currentUser.name}.`);
                    renderActiveBox();
                    renderQueue();
                } catch (err) {
                    showToast(`An unexpected error occurred: ${err.message}`, 'error');
                } finally {
                    isLoading = false;
                    UI.scannerInput.disabled = false;
                    UI.scannerInput.value = '';
                    UI.scannerInput.placeholder = activeBox ? "Scan GKB Order #" : "Scan Box ID";
                    UI.scannerInput.focus();
                }
            };

            const packItem = async (orderNo) => {
                if (!activeBox) { showToast('Error: No active box. Scan a box ID first.', 'error'); return; }

                const order = activeBox.orders.find(o => o.gkb_order_no === orderNo);
                
                if (!order) {
                    const { data: otherOrder } = await db.from('orders').select('*').eq('gkb_order_no', orderNo).single();
                    if (otherOrder && otherOrder.status !== 'Packed') {
                        showExceptionModal(otherOrder);
                    } else {
                        addLogEntry(`Scan failed: Order <strong class="font-mono">${orderNo}</strong> does not belong in this box or is already packed.`, 'error');
                        showToast(`Error: Order "${orderNo}" is invalid for this box.`, 'error');
                    }
                    return;
                }

                if (order.status === 'Packed') { showToast(`Warning: Order "${orderNo}" is already packed.`, 'info'); return; }

                const { error } = await db.from('orders').update({ status: 'Packed', updated_by: currentUser.id }).eq('gkb_order_no', orderNo);
                
                if (error) { showToast(`DB Error: ${error.message}`, 'error'); return; }
                
                order.status = 'Packed';
                
                // **FIX START**: Check for completion *after* the UI is updated.
                const packedCount = activeBox.orders.filter(o => o.status === 'Packed').length;
                const totalCount = activeBox.orders.length;

                renderActiveBox(); // Render first to show the item as packed
                addLogEntry(`Order <strong class="font-mono">${orderNo}</strong> packed into <strong class="font-mono">${activeBox.box_id}</strong>.`);

                if (packedCount === totalCount) {
                    await completeBox();
                }
                // **FIX END**
            };

            const completeBox = async () => {
                const completedBoxId = activeBox.box_id;
                const { error } = await db.from('boxes').update({ status: 'Packed', updated_at: new Date().toISOString(), updated_by: currentUser.id }).eq('box_id', completedBoxId);
                if (error) { showToast(`Failed to complete box: ${error.message}`, 'error'); return; }
                
                addLogEntry(`Box <strong class="font-mono">${completedBoxId}</strong> completed by ${currentUser.name}.`, 'success');
                showToast(`Box ${completedBoxId} complete!`, 'success');
                
                activeBox = null;
                // Refresh the entire queue from the database to ensure it's up to date
                await fetchDispatchQueue();
                renderActiveBox(); // This will now show the placeholder
            };

            const showExceptionModal = (order) => {
                exceptionContext = { order, originalBoxId: order.box_id };
                UI.exceptionMessage.innerHTML = `Order <strong class="font-mono">${order.gkb_order_no}</strong> belongs to Box <strong class="font-mono">${order.box_id}</strong>. Do you want to move it to the active box?`;
                UI.exceptionReason.value = '';
                UI.exceptionModal.classList.add('active');
            };

            const handleExceptionConfirm = async () => {
                const { order, originalBoxId } = exceptionContext;
                const targetBoxId = activeBox.box_id;
                const reason = UI.exceptionReason.value.trim();

                addLogEntry(`Attempting to move <strong class="font-mono">${order.gkb_order_no}</strong> from <strong class="font-mono">${originalBoxId}</strong> to <strong class="font-mono">${targetBoxId}</strong>.`, 'warning');
                
                const { error: updateError } = await db.from('orders').update({ box_id: targetBoxId }).eq('gkb_order_no', order.gkb_order_no);
                if (updateError) { 
                    showToast('DB Error: Could not move order.', 'error'); 
                    console.error("DB Error on exception confirm:", updateError);
                    return; 
                }
                
                const { error: logError } = await db.from('packing_exceptions').insert({
                    gkb_order_no: order.gkb_order_no,
                    original_box_id: originalBoxId,
                    moved_to_box_id: targetBoxId,
                    moved_by_user_id: currentUser.id,
                    reason: reason || null
                });
                if (logError) { showToast('Warning: Order moved but failed to log event.', 'error'); }

                UI.exceptionModal.classList.remove('active');
                exceptionContext = null;
                showToast(`Order ${order.gkb_order_no} successfully moved!`, 'success');

                await fetchDispatchQueue();
                await activateBox(activeBox.box_id);
            };

            const handleScan = async (scannedValue) => {
                const value = scannedValue.trim();
                if (!value) return;
                UI.scannerInput.value = '';
                UI.scannerInput.focus();

                const isBoxInQueue = dispatchQueue.some(b => b.box_id === value);
                if (isBoxInQueue) {
                    await activateBox(value);
                } else {
                    await packItem(value);
                }
            };
            
            // --- RENDER FUNCTIONS ---
            const renderQueue = () => {
                UI.packingQueue.innerHTML = '';
                if (dispatchQueue.length === 0) {
                    UI.queuePlaceholder.innerHTML = `<i class="ph-bold ph-stack text-6xl text-slate-400 mx-auto"></i><p class="mt-4 font-semibold text-slate-600">No boxes are pending for packing.</p>`;
                    UI.packingQueue.appendChild(UI.queuePlaceholder);
                    return;
                }
                
                dispatchQueue.forEach(box => {
                    const div = document.createElement('div');
                    const isActive = activeBox && box.box_id === activeBox.box_id;
                    div.className = `queue-item p-4 rounded-lg shadow-sm transition-all cursor-pointer bg-white border-l-slate-300 ${isActive ? 'active' : ''}`;
                    div.dataset.boxId = box.box_id;
                    div.innerHTML = `<p class="font-bold text-sm font-mono">${box.box_id}</p><p class="text-xs text-slate-600 mt-1">${box.store_name} - ${box.city}</p>`;
                    div.addEventListener('click', () => handleScan(box.box_id));
                    UI.packingQueue.appendChild(div);
                });
            };
            
            const renderActiveBox = () => {
                if (!activeBox) {
                    UI.activeBoxPlaceholder.classList.remove('hidden');
                    UI.activeBoxDetails.classList.add('hidden');
                    UI.scannerLabel.textContent = 'Scan Box ID to Activate';
                    return;
                }

                UI.activeBoxPlaceholder.classList.add('hidden');
                UI.activeBoxDetails.classList.remove('hidden');
                UI.scannerLabel.textContent = 'Scan GKB Order # to Pack';

                UI.boxIdDisplay.textContent = activeBox.box_id;
                UI.storeInfoDisplay.textContent = `${activeBox.store_name} - ${activeBox.city}`;

                UI.pendingItems.innerHTML = '';
                UI.packedItems.innerHTML = '';
                const packedCount = activeBox.orders.filter(o => o.status === 'Packed').length;
                
                activeBox.orders.sort((a,b) => a.gkb_order_no.localeCompare(b.gkb_order_no)).forEach(order => {
                    const li = document.createElement('li');
                    li.className = `font-mono text-sm p-2 rounded-md flex justify-between items-center`;
                    li.innerHTML = `<span>${order.gkb_order_no}</span><span class="text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded">${order.store_code}</span>`;
                    
                    if (order.status === 'Packed') {
                        li.classList.add('packed-item');
                        UI.packedItems.prepend(li);
                    } else {
                        li.classList.add('bg-slate-50', 'shadow-sm');
                        UI.pendingItems.appendChild(li);
                    }
                });

                const totalCount = activeBox.orders.length;
                const percentage = totalCount > 0 ? (packedCount / totalCount) * 100 : 0;
                UI.progressText.textContent = `${packedCount} / ${totalCount}`;
                UI.progressBar.style.width = `${percentage}%`;
            };

            // --- INITIALIZATION & USER SETUP ---
            const initializeApp = async () => {
                const { data: { session } } = await db.auth.getSession();
                if (!session) { redirectTo('login.html'); return; }

                const { data: { user } } = await db.auth.getUser();
                const { data: userProfile, error } = await db.from('users').select('full_name, role').eq('id', user.id).single();
                
                if (error || !userProfile) {
                    currentUser = { id: user.id, name: user.email, role: 'packer' };
                } else {
                    currentUser = { id: user.id, name: userProfile.full_name, role: userProfile.role };
                }

                UI.userDisplay.textContent = currentUser.name;
                UI.userRoleDisplay.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                UI.userInitials.textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                addLogEntry(`Application initialized for user <strong class="font-semibold">${currentUser.name}</strong>.`);
                
                fetchDispatchQueue();
                UI.scannerInput.focus();
            };

            // --- EVENT LISTENERS ---
            UI.scannerInput.addEventListener('change', (e) => handleScan(e.target.value));
            UI.exceptionConfirmBtn.addEventListener('click', handleExceptionConfirm);
            UI.exceptionCancelBtn.addEventListener('click', () => UI.exceptionModal.classList.remove('active'));
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (UI.exceptionModal.classList.contains('active')) {
                        UI.exceptionModal.classList.remove('active');
                        exceptionContext = null;
                    } else if (activeBox) {
                        activeBox = null;
                        renderActiveBox();
                        renderQueue();
                        addLogEntry('Active box cleared.');
                    }
                }
            });
            UI.logoutBtn.addEventListener('click', async () => { await db.auth.signOut(); redirectTo('login.html'); });
            UI.sidebarToggle.addEventListener('click', () => {
                UI.sidebar.classList.toggle('collapsed');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-right');
                UI.sidebarToggle.querySelector('i').classList.toggle('ph-caret-left');
            });
            UI.themeToggle.addEventListener('click', () => {
                const newTheme = (localStorage.getItem('theme') || 'light') === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });

            // Start the application
            setTheme(localStorage.getItem('theme') || 'light');
            initializeApp();
        });
    </script>
</body>
</html>
