<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Delivery</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        [data-theme="dark"] body {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        [data-theme="dark"] .bg-white { background-color: #1e293b; }
        [data-theme="dark"] .text-slate-800 { color: #f1f5f9; }
        [data-theme="dark"] .text-slate-900 { color: #ffffff; }
        [data-theme="dark"] .text-slate-600 { color: #94a3b8; }
        [data-theme="dark"] .text-slate-500 { color: #64748b; }
        [data-theme="dark"] .border-slate-200 { border-color: #334155; }
        [data-theme="dark"] .bg-slate-50 { background-color: #334155; }
        [data-theme="dark"] .bg-slate-100 { background-color: #475569; }
        [data-theme="dark"] .text-indigo-600 { color: #a5b4fc; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .content-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .checkbox-item input:checked ~ div {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        [data-theme="dark"] .checkbox-item input:checked ~ div {
            background-color: #3730a3;
        }
        .checkbox-item input:checked ~ div span {
            text-decoration: line-through;
            color: #64748b;
        }
        [data-theme="dark"] .checkbox-item input:checked ~ div span {
            color: #94a3b8;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- App Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-3xl min-h-screen flex flex-col justify-center">

        <!-- Header -->
        <header class="text-center mb-6">
            <div class="flex items-center justify-center space-x-3">
                <div class="bg-indigo-600 p-3 rounded-xl shadow-lg">
                    <i class="ph-bold ph-package text-2xl text-white"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Delivery Confirmation</h1>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-slate-200">
            
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-16">
                <div class="h-12 w-12 border-4 border-indigo-500 border-t-transparent rounded-full spinner mx-auto"></div>
                <p class="mt-4 font-semibold text-slate-600">Loading shipment details...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center py-16">
                <i class="ph-bold ph-warning-circle text-6xl text-rose-500 mx-auto"></i>
                <p id="error-message" class="mt-4 font-semibold text-slate-600">Could not find shipment details.</p>
                <p class="text-sm text-slate-400 mt-1">Please check the QR code and try again.</p>
            </div>

            <!-- Success State -->
            <div id="success-state" class="hidden text-center py-16 content-fade-in">
                <i class="ph-bold ph-check-circle text-6xl text-emerald-500 mx-auto"></i>
                <p id="success-message" class="mt-4 text-2xl font-semibold text-slate-800">Thank you!</p>
                <p class="text-slate-500 mt-1">Your response has been recorded.</p>
            </div>

            <!-- Confirmation View -->
            <div id="confirmation-view" class="hidden content-fade-in">
                <!-- Box & Store Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 pb-6 border-b border-slate-200">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i class="ph-bold ph-box text-2xl text-indigo-600"></i>
                            <div>
                                <p class="text-sm text-slate-500">Box ID</p>
                                <h2 id="box-id-display" class="text-lg font-bold text-slate-800 font-mono"></h2>
                            </div>
                        </div>
                    </div>
                     <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i class="ph-bold ph-map-pin text-2xl text-indigo-600"></i>
                            <div>
                                <p class="text-sm text-slate-500">Delivered To</p>
                                <p id="store-details-display" class="font-semibold text-slate-700"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Checklist -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-bold text-slate-800">Please confirm all received orders:</p>
                        <button id="select-all-btn" class="text-sm font-semibold text-indigo-600 hover:underline">Select All</button>
                    </div>
                    <ul id="order-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Order items will be injected here -->
                    </ul>
                </div>

                <!-- Input Fields -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name-input" class="block text-sm font-medium text-slate-700">Received By (Your Name)</label>
                        <input type="text" id="name-input" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Enter your full name">
                    </div>
                    <div>
                        <label for="notes-input" class="block text-sm font-medium text-slate-700">Notes (Optional)</label>
                        <textarea id="notes-input" rows="1" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., Box was damaged..."></textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 pt-6 border-t border-slate-200 flex flex-col sm:flex-row-reverse gap-4">
                    <button id="confirm-btn" class="w-full flex items-center justify-center space-x-2 bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 transition-colors">
                        <i class="ph-bold ph-check-circle text-lg"></i>
                        <span>Confirm Receipt of Selected Items</span>
                    </button>
                    <button id="report-issue-btn" class="w-full sm:w-auto flex items-center justify-center space-x-2 bg-rose-600/10 text-rose-700 font-bold py-3 px-4 rounded-lg hover:bg-rose-600/20 transition-colors">
                        <i class="ph-bold ph-warning-circle text-lg"></i>
                        <span>Report Issue</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // UPGRADE: Import credentials from the central config file
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            // --- UI ELEMENTS ---
            const UI = {
                loadingState: document.getElementById('loading-state'),
                errorState: document.getElementById('error-state'),
                errorMessage: document.getElementById('error-message'),
                successState: document.getElementById('success-state'),
                successMessage: document.getElementById('success-message'),
                confirmationView: document.getElementById('confirmation-view'),
                boxIdDisplay: document.getElementById('box-id-display'),
                storeDetailsDisplay: document.getElementById('store-details-display'),
                orderList: document.getElementById('order-list'),
                selectAllBtn: document.getElementById('select-all-btn'),
                nameInput: document.getElementById('name-input'),
                notesInput: document.getElementById('notes-input'),
                confirmBtn: document.getElementById('confirm-btn'),
                reportIssueBtn: document.getElementById('report-issue-btn'),
            };

            let boxData = {};

            // --- CORE LOGIC ---
            const getBoxIdFromUrl = () => {
                const params = new URLSearchParams(window.location.search);
                return params.get('box');
            };

            const showState = (state) => {
                ['loadingState', 'errorState', 'successState', 'confirmationView'].forEach(s => UI[s].classList.add('hidden'));
                if (UI[state]) {
                    UI[state].classList.remove('hidden');
                }
            };

            const submitConfirmation = async (status) => {
                const confirmedOrders = Array.from(UI.orderList.querySelectorAll('input:checked')).map(input => input.value);
                const notes = UI.notesInput.value.trim();
                const confirmedByName = UI.nameInput.value.trim();

                if (!confirmedByName) {
                    alert('Please enter your name in the "Received By" field.');
                    UI.nameInput.focus();
                    return;
                }

                if (status === 'Received' && confirmedOrders.length === 0) {
                     alert('Please check at least one order to confirm receipt, or use the "Report Issue" button if no items were received.');
                     return;
                }
                
                showState('loadingState');

                const allOrders = boxData.orders.map(o => o.gkb_order_no);
                const confirmationData = allOrders.map(orderNo => {
                    const orderStatus = confirmedOrders.includes(orderNo) ? 'Received' : (status === 'Received' ? 'Received' : 'Issue Reported');
                    return {
                        confirmed_by_name: confirmedByName,
                        status: orderStatus,
                        notes: notes,
                        gkb_order_no: orderNo,
                        box_id: boxData.box_id
                    };
                });

                const { error } = await db.from('delivery_confirmations').insert(confirmationData);

                if (error) {
                    showState('errorState');
                    UI.errorMessage.textContent = `There was an error submitting your confirmation.`;
                    console.error("Submission error:", error);
                } else {
                    showState('successState');
                    UI.successMessage.textContent = status === 'Received' 
                        ? 'Thank you for confirming!' 
                        : 'Your issue has been reported. Our team will look into it.';
                }
            };

            const loadBoxDetails = async (boxId) => {
                const { data, error } = await db.from('boxes')
                    .select(`
                        box_id,
                        orders (gkb_order_no, customer_ref),
                        delivery_groups (full_address)
                    `)
                    .eq('box_id', boxId)
                    .single();

                if (error || !data) {
                    showState('errorState');
                    return;
                }

                boxData = data;
                UI.boxIdDisplay.textContent = data.box_id;
                UI.storeDetailsDisplay.textContent = data.delivery_groups.full_address;

                UI.orderList.innerHTML = data.orders.map(order => 
                    `<li class="checkbox-item">
                        <label for="${order.gkb_order_no}" class="flex items-center p-3 rounded-lg transition-all border-2 border-transparent cursor-pointer bg-slate-100">
                            <input type="checkbox" id="${order.gkb_order_no}" value="${order.gkb_order_no}" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded sr-only">
                            <div class="flex-grow flex justify-between items-center">
                                <span class="font-mono text-sm text-slate-700">${order.gkb_order_no}</span>
                                <span class="text-xs text-slate-500 ml-2">(Ref: ${order.customer_ref})</span>
                            </div>
                        </label>
                    </li>`
                ).join('');
                
                showState('confirmationView');
            };

            // --- INITIALIZATION ---
            const boxId = getBoxIdFromUrl();
            if (!boxId) {
                showState('errorState');
            } else {
                loadBoxDetails(boxId);
            }

            UI.confirmBtn.addEventListener('click', () => submitConfirmation('Received'));
            UI.reportIssueBtn.addEventListener('click', () => submitConfirmation('Issue Reported'));
            UI.selectAllBtn.addEventListener('click', () => {
                const checkboxes = UI.orderList.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
            });

            // Auto-detect and set theme
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        });
    </script>
</body>
</html>
